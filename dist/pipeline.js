"use strict";var q=Object.create;var P=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var U=Object.getOwnPropertyNames;var E=Object.getPrototypeOf,F=Object.prototype.hasOwnProperty;var J=(n,e,r,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of U(e))!F.call(n,t)&&t!==r&&P(n,t,{get:()=>e[t],enumerable:!(i=k(e,t))||i.enumerable});return n};var d=(n,e,r)=>(r=n!=null?q(E(n)):{},J(e||!n||!n.__esModule?P(r,"default",{value:n,enumerable:!0}):r,n));var m=(n,e,r)=>new Promise((i,t)=>{var a=s=>{try{f(r.next(s))}catch(y){t(y)}},u=s=>{try{f(r.throw(s))}catch(y){t(y)}},f=s=>s.done?i(s.value):Promise.resolve(s.value).then(a,u);f((r=r.apply(n,e)).next())});var x=d(require("path")),w=x.default.join("data","revistas");function N(n){return{revista:{numero:T(n),dataPublicacao:L(n),diretoria:M(n),despachos:C(n)}}}function T(n){var e,r,i,t;if((r=(e=n==null?void 0:n.revista)==null?void 0:e.$)!=null&&r.numero)return(t=(i=n==null?void 0:n.revista)==null?void 0:i.$)==null?void 0:t.numero}function L(n){var e,r,i,t;if((r=(e=n==null?void 0:n.revista)==null?void 0:e.$)!=null&&r.dataPublicacao)return(t=(i=n==null?void 0:n.revista)==null?void 0:i.$)==null?void 0:t.dataPublicacao}function M(n){var e,r,i,t;if((r=(e=n==null?void 0:n.revista)==null?void 0:e.$)!=null&&r.diretoria)return(t=(i=n==null?void 0:n.revista)==null?void 0:i.$)==null?void 0:t.diretoria}function C(n){var r,i,t;let e=a=>({codigo:B(a),titulo:O(a),processoPatente:G(a)});if((r=n==null?void 0:n.revista)!=null&&r.despacho&&Array.isArray((i=n==null?void 0:n.revista)==null?void 0:i.despacho))return(t=n==null?void 0:n.revista)==null?void 0:t.despacho.map(e)}function B(n){if(n!=null&&n.codigo&&(n==null?void 0:n.codigo.length)>0)return n==null?void 0:n.codigo[0]}function O(n){if(n!=null&&n.titulo&&(n==null?void 0:n.titulo.length)>0)return n==null?void 0:n.titulo[0]}function G(n){if(!(n!=null&&n["processo-patente"])||!Array.isArray(n["processo-patente"])||n["processo-patente"].length===0)return;let e=n["processo-patente"][0];return{numero:W(e),dataDeposito:H(e),dataConcessao:X(e),dataFaseNacional:Z(e),pedidoInternacional:K(e),publicacaoInternacional:Q(e),titulo:V(e),IPC:Y(e),titulares:b(e),inventores:j(e),prioridadesUnionistas:nn(e),divisaoPedido:en(e),pedidoPrincipal:rn(e)}}function W(n){let e=o(n==null?void 0:n.numero);if(e!=null&&e._)return e._}function H(n){let e=o(n==null?void 0:n["data-deposito"]);if(e!=null&&e._)return e._}function X(n){let e=o(n==null?void 0:n.concessao),r=o(e==null?void 0:e.data);if(r)return r}function Z(n){let e=o(n==null?void 0:n["data-fase-nacional"]);if(e!=null&&e._)return e._}function K(n){let e=o(n==null?void 0:n["pedido-internacional"]);if(!e)return;let r=o(e["numero-pct"]),i=o(e["data-pct"]);if(!(!r&&!i))return{numeroPCT:r,dataPCT:i}}function Q(n){let e=o(n==null?void 0:n["publicacao-internacional"]);if(!e)return;let r=o(e["numero-ompi"]),i=o(e["data-ompi"]);if(!(!r&&!i))return{numeroOMPI:r,dataOMPI:i}}function V(n){let e=o(n==null?void 0:n.titulo);if(e!=null&&e._)return e._}function Y(n){let e=o(n==null?void 0:n["classificacao-internacional-lista"]);if(p(e==null?void 0:e["classificacao-internacional"]))return e["classificacao-internacional"].reduce((r,i)=>(i!=null&&i._&&r.push(i._),r),[])}function b(n){let e=o(n==null?void 0:n["titular-lista"]);if(p(e==null?void 0:e.titular))return e.titular.reduce((r,i)=>{let t=o(i==null?void 0:i["nome-completo"]),a=o(i==null?void 0:i.endereco),u=o(a==null?void 0:a.uf),f=o(a==null?void 0:a.pais),s=o(f==null?void 0:f.sigla);return!t&&!u&&!s||r.push({nomeCompleto:t,uf:u,pais:s}),r},[])}function j(n){let e=o(n==null?void 0:n["inventor-lista"]);if(p(e==null?void 0:e.inventor))return e.inventor.reduce((r,i)=>{let t=o(i==null?void 0:i["nome-completo"]);return t&&r.push(t),r},[])}function nn(n){let e=o(n==null?void 0:n["prioridade-unionista-lista"]);if(p(e==null?void 0:e["prioridade-unionista"]))return e["prioridade-unionista"].reduce((r,i)=>{var f,s,y;let t=(f=o(i==null?void 0:i["sigla-pais"]))==null?void 0:f._,a=(s=o(i==null?void 0:i["numero-prioridade"]))==null?void 0:s._,u=(y=o(i==null?void 0:i["data-prioridade"]))==null?void 0:y._;if(!(!t&&!a&&!u))return r.push({siglaPais:t,numeroPrioridade:a,dataPrioridade:u}),r},[])}function en(n){let e=o(n==null?void 0:n["divisao-pedido"]);if(!e)return;let r=o(e["data-deposito"]),i=o(e.numero);if(!(!r&&!i))return{dataDeposito:r,numero:i}}function rn(n){let e=o(n==null?void 0:n["pedido-principal"]);if(!e)return;let r=o(e["data-deposito"]),i=o(e.numero);if(!(!r&&!i))return{dataDeposito:r,numero:i}}function o(n){if(p(n)&&n[0])return n[0]}function p(n){return!!(n&&Array.isArray(n)&&n.length>0)}var h=d(require("adm-zip")),l=d(require("fs")),S=d(require("path")),_=d(require("xml2js"));var R=require("date-fns"),$=d(require("path")),I=d(require("fs")),c=class{constructor(e,r){this.section=e;this.number=r;this.baseUrl="http://revistas.inpi.gov.br/txt/"}static get lastPublication(){let r=new Date(2023,4,2),t=(0,R.differenceInDays)(new Date,r);return Math.floor(t/7)+2730}get isDownloaded(){return[".zip",".json",".new.json"].some(r=>{let i=$.default.join(this.section.directoryPath,`${this.identifier}${r}`);return I.default.existsSync(i)})}get url(){return new URL(`${this.section.identifier}${this.number}.zip`,this.baseUrl)}get identifier(){return`${this.section.identifier}${this.number}`}};c.firstJournal=2474;var g=class{constructor(e,r){this.identifier=e;this.directoryPath=r}downloadAll(){return m(this,null,function*(){let e=this.createDownloadList();if(e.length===0)return;let r=100,i=6e4,t=a=>m(this,null,function*(){return new Promise(u=>setTimeout(u,a))});for(let a=0;a<e.length;a+=r){let u=e.slice(a,a+r);Promise.allSettled(u.map(s=>this.download(s))),a+r>=e.length||(yield t(i))}})}parseAll(){return m(this,null,function*(){let e=l.default.readdirSync(this.directoryPath).filter(r=>r.endsWith(".zip")).map(r=>S.default.join(this.directoryPath,r)).filter(r=>{let i=r.replace(".zip",".json"),t=r.replace(".zip",".new.json");return!l.default.existsSync(i)&&!l.default.existsSync(t)});for(let r of e){let t=new h.default(r).getEntries().find(s=>s.name.endsWith(".xml"));if(!t){console.warn(`${r} does not have a XML file`);return}let a=t==null?void 0:t.getData().toString("utf-8"),u=this.parse(yield _.default.parseStringPromise(a));if(!u)return;let f=r.replace(".zip",".new.json");l.default.writeFileSync(f,JSON.stringify(u))}})}download(e){return m(this,null,function*(){try{l.default.existsSync(this.directoryPath)||l.default.mkdirSync(this.directoryPath,{recursive:!0});let r=yield fetch(e,{method:"GET"});if(r.url.includes("error")||r.redirected){console.error(`Error while downloading "${e.href}"`);return}let i=Buffer.from(yield r.arrayBuffer());new h.default(i);let t=e.pathname.replace("/txt/",""),a=S.default.join(this.directoryPath,t),u=l.default.openSync(a,"w");l.default.writeSync(u,i),l.default.closeSync(u)}catch(r){console.error(`Error while downloading "${e.href}"`)}})}createDownloadList(){let e=[];for(let r=c.firstJournal;r<=c.lastPublication;r++){let i=new c(this,r);i.isDownloaded||e.push(i.url)}return e}};var z=d(require("path")),D=class extends g{constructor(){super("P",z.default.join(w,"patente"))}parse(e){return N(e)}};var A=d(require("path")),v=class extends g{constructor(){super("PC",A.default.join(w,"programa-computador"))}parse(e){return null}};m(exports,null,function*(){let n=[new D,new v];for(let e of n)yield e.downloadAll(),yield e.parseAll()});
